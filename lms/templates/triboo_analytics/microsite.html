<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%!
    from django.utils.translation import ugettext as _
    from django.utils.translation import ungettext
    from django.core.urlresolvers import reverse
    from triboo_analytics.models import format_time_spent, ANALYTICS_LIMITED_ACCESS_GROUP
%>

<%block name="headextra">
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="${static.url('js/triboo_analytics/charts.js')}"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
</%block>

<%block name="pagetitle">${_("Analytics - Global Report")}</%block>
<%block name="bodyclass">view-in-analytics</%block>

<main id="main" aria-label="Content" tabindex="-1">
    <div class="main-container">
        <section class="banner">
          <section class="welcome-wrapper">
            <h2>${_("Analytics")}</h2>
            <h3>${_("Let's have a look at your learning data")}</h3>
          </section>
        </section>
        <nav>
            <ol class="tabs analytics-tabs">
                <li class="tab"><a href="${reverse('analytics_microsite')}" class="active">${_("Global Report")}</a></li>
                <li class="tab"><a href="${reverse('analytics_course')}">${_("Course Report")}</a></li>
              % if ANALYTICS_LIMITED_ACCESS_GROUP not in [group.name for group in user.groups.all()]:
                <li class="tab"><a href="${reverse('analytics_learner')}">${_("Learner Report")}</a></li>
              % endif
                <li class="tab"><a href="${reverse('analytics_ilt')}">${_("ILT Report")}</a></li>
            </ol>
        </nav>
        <section class="analytics-wrapper microsite">
            <div class="report-wrapper">
              % if microsite_report:
                <div class="analytics-basic-wrapper">
                    <div class="analytics-widget-24 analytics-figure">
                        <p class="figure">${microsite_report.courses}</p>
                        <p class="title">${ungettext("Course", "Courses", microsite_report.courses)}</p>
                    </div>
                    <div class="analytics-widget-24 analytics-figure">
                        <p class="figure">${microsite_report.users}</p>
                        <p class="title">${ungettext("Active Learner", "Active Learners", microsite_report.users)}</p>
                    </div>
                    <div class="analytics-widget-24 analytics-figure">
                        <p class="figure">${microsite_report.finished}</p>
                        <p class="title">${ungettext("Certificate Delivered", "Certificates Delivered", microsite_report.finished)}</p>
                    </div>
                    <div class="analytics-widget-24 analytics-figure">
                        <p class="figure">${format_time_spent(microsite_report.average_time_spent)}</p>
                        <p class="title">${_("Average Time Spent Per Active Learner")}</p>
                    </div>
                </div>

                <div class="analytics-basic-wrapper">
                    <div class="analytics-widget-75 analytics-linechart">
                        <h3>${_("Number of Unique Visitors")}</h3>
                        <div id="lineChart">
                            <svg>
                                <defs>
                                    <linearGradient id="lineChart--gradientBackgroundArea" x1="0" x2="0" y1="0" y2="1">
                                      <stop class="lineChart--gradientBackgroundArea--top" offset="0%" />
                                      <stop class="lineChart--gradientBackgroundArea--bottom" offset="100%" />
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                    </div>
                    <div class="analytics-widget-24 analytics-piechart">
                        <h3>${_("Device Use")}</h3>
                        <div id="pieChart">
                            <svg></svg>
                        </div>
                        <div class="legend">
                            <p><span class="desktop">&#9679;</span> ${_("Desktop")}</p>
                            <p><span class="mobile">&#9679;</span> ${_("Mobile")}</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-widget-100 analytics-map">
                    <h3>${_("Active Learners Location")}</h3>
                    <div id="map">
                        <svg></svg>
                    </div>
                </div>

                <div class="last-update">
                  <i class="fa fa-history"></i>${_("Please, note that these reports are not live. Last update:")} ${last_update}
                </div>
              % endif
            </div>
        </section>
    </div>
</main>

% if (microsite_report and len(unique_visitors_csv_data) > 0):
    <script type="text/javascript">
        var lineChartCsvData = "date,value\n" + "${unique_visitors_csv_data}";
        drawLineChart('lineChart', lineChartCsvData);
    </script>
% endif
% if (microsite_report and (microsite_report.total_time_spent_on_desktop + microsite_report.total_time_spent_on_mobile) > 0):
    <script type="text/javascript">
        var total = ${microsite_report.total_time_spent_on_desktop} + ${microsite_report.total_time_spent_on_mobile};
        var pieChartData = [
          {
            color    : 'desktop',
            percent  : ${microsite_report.total_time_spent_on_desktop} / total
          },
          {
            color    : 'mobile',
            percent  : ${microsite_report.total_time_spent_on_mobile} / total
          }
        ];

        drawPieChart('pieChart', pieChartData);
    </script>
% endif
% if len(users_by_country_csv_data) > 0:
    <script type="text/javascript">
        var mapCsvData =  "id,label,value\n" + "${users_by_country_csv_data}";
        drawMap('map', mapCsvData, '${static.url('js/triboo_analytics/world-110m.v1.json')}');
    </script>
% endif

