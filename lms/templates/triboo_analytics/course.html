<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%!
    from urllib import urlencode
    from django.utils.translation import ugettext as _, ungettext, gettext
    from django.core.urlresolvers import reverse
    from django.template import Template, Context
    from triboo_analytics.models import CourseStatus, format_time_spent

    import json
    from openedx.core.djangolib.markup import HTML
    from webpack_loader.templatetags.webpack_loader import render_bundle
%>

<%block name="pagetitle">${_("Analytics - Course Report")}</%block>
<%block name="bodyclass">view-in-analytics</%block>
<main id="main" aria-label="Content" tabindex="-1">
    <div class="main-container">
        <%include file="banner_nav.html" args="active_page='course'" />
        <section class="analytics-wrapper course">
          <div class="report-wrapper">
                <div class="analytics-header">
                  % if courses:
                    <form action="${reverse('analytics_course')}" method="get">
                        <label for="course_id">${_("Please select a course to see your report:")}</label>
                        <select name="course_id">
                        % for cid, course_title in courses:
                          % if cid == course_id:
                            <option value="${cid}" selected="selected">${course_title}</option>
                          % else:
                            <option value="${cid}">${course_title}</option>
                          % endif
                        % endfor
                        </select>
                        <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">
                        <input type="submit" value="${_("Go")}">
                    </form>
                  % endif
                </div>
                <div class="analytics-header">
                  % if error_message:
                    <p class="error">${error_message}</p>
                  % endif
                  % if course_name:
                    <a href="${reverse('info', args=[course_id])}"><h2>${course_name}</h2></a>
                  % endif
                </div>
            % if course_report:
                <div class="analytics-basic-wrapper">
                    <div class="analytics-float-wrapper">
                        <div class="analytics-basic-wrapper">
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-enrollments",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Number of learners enrolled in the course. The learners have been registered by an Admin or self-registered via the catalog'),
                                  }
                                )}
                                <p class="figure">${course_report.enrollments}</p>
                                <p class="title">${ungettext("Enrollment", "Enrollments", course_report.enrollments)}</p>
                            </div>
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-average-time",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Average time it took to learners to complete the course with 100% progress'),
                                  }
                                )}
                                <p class="figure">${format_time_spent(course_report.average_complete_time)}</p>
                                <p class="title">${_("Average time to complete the course")}</p>
                            </div>
                        </div>
                        <div class="analytics-basic-wrapper">
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-average-final-score",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Average total score of the learners who completed the course with 100% progress'),
                                  }
                                )}
                                <p class="figure">${course_report.average_final_score}&nbsp;%</p>
                                <p class="title">${_("Average Final Score")}</p>
                            </div>
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-posts",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Number of posts/answers/comments written in the course discussions/forums'),
                                  }
                                )}
                                <p class="figure">${course_report.posts}</p>
                                <p class="title">${ungettext("Post", "Posts", course_report.posts)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-float-wrapper analytics-piechart-wrapper">
                      <div class="analytics-widget-24 analytics-piechart">
                          ${static.renderReact(
                              component="QuestionMark",
                              id="id-donuts-chart",
                              props={
                                'class':'question-mark',
                                'tooltip': gettext('Proportion of learners according to their course status'),
                              }
                            )}

                        <div id="pieChart">
                            <svg></svg>
                        </div>
                        <div class="legend">
                            <div class="status-label">
                                <span class="finished">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.finished])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-finished-2",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext('Leaners who completed the course with 100% progress and a total score passing the minimum required score'),
                                  }
                                )}
                            </div>
                            <div class="status-label">
                                <span class="failed">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.failed])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-failed",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext('Leaners who completed the course with 100% progress but with a total score below the minimum required score to validate the course'),
                                  }
                                )}
                            </div>
                            <div class="status-label">
                                <span class="in-progress">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.in_progress])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-in-progress",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext("Learners who started to visit the course but haven't completed it yet"),
                                  }
                                )}
                            </div>
                            <div class="status-label">
                                <span class="not-started">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.not_started])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-not-started",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext("Learners who are enrolled in the course but haven't visited it yet"),
                                  }
                                )}
                            </div>
                        </div>
                      </div>
                    </div>
                </div>
              % if len(unique_visitors_csv_data) > 0:
                <div class="analytics-widget-100 analytics-linechart">
                    ${static.renderReact(
                      component="QuestionMark",
                      id="id-number-of-enrollments",
                      props={
                        'class':'question-mark',
                        'tooltip': gettext('Cumulative number of enrollments over time'),
                      }
                    )}
                    <h3>${_("Number of Enrollments")}</h3>
                    <div class="line-chart-wrapper">
                        <div id="lineChart">
                            <svg>
                                <defs>
                                    <linearGradient id="lineChart--gradientBackgroundArea" x1="0" x2="0" y1="0" y2="1">
                                      <stop class="lineChart--gradientBackgroundArea--top" offset="0%" />
                                      <stop class="lineChart--gradientBackgroundArea--bottom" offset="100%" />
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                    </div>
                </div>
              % endif
                <div class="last-update">
                  <i class="fa fa-history"></i>${_("Please, note that these reports are not live. Last update:")} ${last_update}
                </div>

                ${HTML(render_bundle('CourseReport'))}
                ${HTML(render_bundle('ReactRenderer'))}
                <div id="course-report"></div>
                <script type="text/javascript">
                  new ReactRenderer({
                    component: CourseReport,
                    selector: '#course-report',
                    componentName: 'CourseReport',
                    props: {
                        defaultLanguage: '${request.LANGUAGE_CODE}',
                        token:'${ csrf_token }',
                      }
                  });
                </script>

                <div>-----------------spliter----------------------------------spliter----------------------------------spliter-----------------</div>

              % if show_base == 'true':
              <%
              summary_url = "%s?%s" % (reverse('analytics_course'), urlencode({'course_id': course_id, 'report': 'summary'}))
              progress_url = "%s?%s" % (reverse('analytics_course'), urlencode({'course_id': course_id, 'report': 'progress'}))
              time_spent_url = "%s?%s" % (reverse('analytics_course'), urlencode({'course_id': course_id, 'report': 'time_spent'}))
              %>
              % if learner_course_table:
                <ul class="analytics-nav">
                    <li class="nav-item active">${_("Summary")}</li>
                    <li class="nav-item"><a href="${progress_url}">${_("Progress")}</a></li>
                    <li class="nav-item"><a href="${time_spent_url}">${_("Time Spent")}</a></li>
                </ul>
              % elif learner_course_progress_table:
                  <ul class="analytics-nav">
                      <li class="nav-item"><a href="${summary_url}">${_("Summary")}</a></li>
                      <li class="nav-item active">${_("Progress")}</li>
                      <li class="nav-item"><a href="${time_spent_url}">${_("Time Spent")}</a></li>
                  </ul>
              % elif learner_course_time_spent_table:
                  <ul class="analytics-nav">
                      <li class="nav-item"><a href="${summary_url}">${_("Summary")}</a></li>
                      <li class="nav-item"><a href="${progress_url}">${_("Progress")}</a></li>
                      <li class="nav-item active">${_("Time Spent")}</li>
                  </ul>
              % endif
              <div class="filter-section">
                  <div class="filter-forms">
                    <form class="table-filter-form" action="${reverse('analytics_course')}" method="get">
                        ${filter_form}
                        % for key, value in query_dict.items():
                            <input type="hidden" value="${value}" name="${key}"/>
                        % endfor
                    </form>
                    <form class="clear-filter-form" action="${reverse('analytics_course')}" method="get">
                        <span style="display: none">${filter_form}</span>
                        <input type="hidden" value="1" name="clear">
                        <input type="hidden" value="" name="query_string">
                        <input type="hidden" value="Name" name="queried_field">
                        <button type="submit" id="clear-all-filters" class="clear-filters reset-button">
                            <i class="fa fa-refresh icon"></i>${_("Reset")}
                        </button>
                    </form>
                  </div>
                  <div class="delete-filter-forms">
                  % for query_string, queried_field, queried_field_name in query_triples:
                    <form class="delete-filter-form" action="${reverse('analytics_course')}" method="get">
                        <span style="display: none">${filter_form}</span>
                        <input type="hidden" value="1" name="delete">
                        % for key, value in query_dict.items():
                            <input type="hidden" value="${value}" name="${key}"/>
                        % endfor
                        <input type="hidden" value="${query_string}" name="query_string">
                        <input type="hidden" value="${queried_field_name}" name="queried_field">
                        <button type="submit" class="delete-filter">
                            <span class="query">${_(queried_field)}: ${query_string}</span>
                            <span aria-hidden="true" class="fa fa-times"></span>
                        </button>
                    </form>
                  % endfor
                  </div>
              </div>
                <form class="table-user-properties-form" action="${reverse('analytics_course')}" method="get">
                    <a href="#" id="toggle-user-properties"><i class="fa fa-angle-double-down"></i> ${_("Select the user properties you want to display")}</a>
                    <div id="user-properties-selection">
                        ${user_properties_form}
                        % for key, value in query_dict.items():
                            <input type="hidden" value="${value}" name="${key}"/>
                        % endfor
                        <input type="submit" value="${_("Go")}"/>
                    </div>
                </form>

              % if learner_course_table:
                <% tpl = "{% load render_table from django_tables2 %}{% render_table learner_course_table 'triboo_analytics/table.html' %}" %>
                ${Template(tpl).render(Context({'learner_course_table': learner_course_table,
                                                'request': request,
                                                'row_count': row_count}))}

              % elif learner_course_progress_table:
                <% tpl = "{% load render_table from django_tables2 %}{% render_table learner_course_progress_table 'triboo_analytics/table.html' %}" %>
                ${Template(tpl).render(Context({'learner_course_progress_table': learner_course_progress_table,
                                                'request': request,
                                                'row_count': row_count}))}

              % elif learner_course_time_spent_table:
                <% tpl = "{% load render_table from django_tables2 %}{% render_table learner_course_time_spent_table 'triboo_analytics/table-double-header.html' %}" %>
                ${Template(tpl).render(Context({'learner_course_time_spent_table': learner_course_time_spent_table,
                                                'request': request,
                                                'row_count': row_count}))}
              % endif

              % endif

            % endif
          </div>
        </section>
    </div>
</main>

##<%static:webpack entry="CourseReport">
##    new CourseReport();
##</%static:webpack>

% if course_report:
    <!-- load the d3.js library -->
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="${static.url('js/triboo_analytics/charts.js')}"></script>

    <!-- the script -->
    <script type="text/javascript">
    var pieChartData = [
      {
        color       : 'green',
        value       : ${course_report.finished},
        percent     : ${course_report.finished} / ${course_report.enrollments}
      },
      {
        color       : 'red',
        value       : ${course_report.failed},
        percent     : ${course_report.failed} / ${course_report.enrollments}
      },
      {
        color       : 'orange',
        value       : ${course_report.in_progress},
        percent     : ${course_report.in_progress} / ${course_report.enrollments}
      },
      {
        color       : 'gray',
        value       : ${course_report.not_started},
        percent     : ${course_report.not_started} / ${course_report.enrollments}
      }
    ];

    drawPieChart('pieChart', pieChartData);
    </script>
% endif
% if unique_visitors_csv_data and len(unique_visitors_csv_data) > 0:
    <script type="text/javascript">
        var lineChartCsvData = "date,value\n" + "${unique_visitors_csv_data}";
        drawLineChart('lineChart', lineChartCsvData, 0, 0);
    </script>
% endif
<script type="text/javascript">
  $(function() {
    var pull = $('#toggle-user-properties');
    var menu = $('#user-properties-selection');

    $(pull).on('click', function(e) {
      e.preventDefault();
      menu.slideToggle();
    });

    $(window).on("load", function() {
        $(".table-filter-form #id_query_string").val("");
        $(".table-filter-form #id_queried_field").find("option[value='user__profile__name']").attr("selected",true)
    });
  });
</script>

