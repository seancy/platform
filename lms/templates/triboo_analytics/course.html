<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%!
    from urllib import urlencode
    from django.utils.translation import ugettext as _, ungettext, gettext
    from django.core.urlresolvers import reverse
    from django.template import Template, Context
    from triboo_analytics.models import CourseStatus, format_time_spent

    import json
    from openedx.core.djangolib.markup import HTML
    from webpack_loader.templatetags.webpack_loader import render_bundle
%>

<%block name="pagetitle">${_("Analytics - Course Report")}</%block>
<%block name="bodyclass">view-in-analytics</%block>
<main id="main" aria-label="Content" tabindex="-1">
    <div class="main-container">
        <%include file="banner_nav.html" args="active_page='course'" />

        ${HTML(render_bundle('CourseReport'))}
        ${HTML(render_bundle('ReactRenderer'))}

        <section class="analytics-wrapper course">
          <div class="report-wrapper">
              <h3>${_("Course Report")}</h3>
              <div class="analytics-header" id="course-report-dropdown"></div>
            % if courses:
              <script type="text/javascript">
                new ReactRenderer({
                  component: CourseReportDropdown,
                  selector: '#course-report-dropdown',
                  componentName: 'CourseReportDropdown',
                  props: {
                      'token':'${ csrf_token }',
                      'submitText':'${_("Go")}',
                      'labelText':'${_("Please select a course to see your report:")}',

                      'data':${json.dumps([{'value': item[0], 'text':item[1]} for item in courses]) | n},
                      'value':'${course_id}',
                      'url':'${reverse("analytics_course")}'
                    }
                });
              </script>
             % endif

              <div class="analytics-header">
                % if error_message:
                  <p class="error">${error_message}</p>
                % endif
                % if course_name:
                  <a href="${reverse('info', args=[course_id])}"><h2><i class="fal fa-file-alt"></i>${course_name}</h2></a>
                % endif
              </div>
            % if course_report:
                <div class="analytics-basic-wrapper">
                    <div class="analytics-float-wrapper">
                        <div class="analytics-basic-wrapper">
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-enrollments",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Number of learners enrolled in the course. The learners have been registered by an Admin or self-registered via the catalog'),
                                  }
                                )}
                                <p class="figure">${course_report.enrollments}</p>
                                <p class="title">${ungettext("Enrollment", "Enrollments", course_report.enrollments)}</p>
                            </div>
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-average-time",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Average time it took to learners to complete the course with 100% progress'),
                                  }
                                )}
                                <p class="figure">${format_time_spent(course_report.average_complete_time)}</p>
                                <p class="title">${_("Average time to complete the course")}</p>
                            </div>
                        </div>
                        <div class="analytics-basic-wrapper">
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-average-final-score",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Average total score of the learners who completed the course with 100% progress'),
                                  }
                                )}
                                <p class="figure">${course_report.average_final_score}&nbsp;%</p>
                                <p class="title">${_("Average Final Score")}</p>
                            </div>
                            <div class="analytics-widget-24 analytics-figure">
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-posts",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Number of posts/answers/comments written in the course discussions/forums'),
                                  }
                                )}
                                <p class="figure">${course_report.posts}</p>
                                <p class="title">${ungettext("Post", "Posts", course_report.posts)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-float-wrapper analytics-piechart-wrapper">
                      <div class="analytics-widget-24 analytics-piechart">
                          ${static.renderReact(
                              component="QuestionMark",
                              id="id-donuts-chart",
                              props={
                                'class':'question-mark',
                                'tooltip': gettext('Proportion of learners according to their course status'),
                              }
                            )}

                        <div id="pieChart">
                            <svg></svg>
                        </div>
                        <div class="legend">
                            <div class="status-label">
                                <span class="finished">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.finished])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-finished-2",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext('Leaners who completed the course with 100% progress and a total score passing the minimum required score'),
                                  }
                                )}
                            </div>
                            <div class="status-label">
                                <span class="failed">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.failed])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-failed",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext('Leaners who completed the course with 100% progress but with a total score below the minimum required score to validate the course'),
                                  }
                                )}
                            </div>
                            <div class="status-label">
                                <span class="in-progress">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.in_progress])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-in-progress",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext("Learners who started to visit the course but haven't completed it yet"),
                                  }
                                )}
                            </div>
                            <div class="status-label">
                                <span class="not-started">&#9679;</span>
                                ${_(CourseStatus.verbose_names[CourseStatus.not_started])}
                                ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-not-started",
                                  props={
                                    'class':'status-message',
                                    'tooltip': gettext("Learners who are enrolled in the course but haven't visited it yet"),
                                  }
                                )}
                            </div>
                        </div>
                      </div>
                    </div>
                </div>
              % if len(unique_visitors_csv_data) > 0:
                <div class="analytics-widget-100 analytics-linechart">
                    ${static.renderReact(
                      component="QuestionMark",
                      id="id-number-of-unique-course-visitors",
                      props={
                        'class':'question-mark',
                        'tooltip': gettext('Number of different visitors who opened the course per day'),
                      }
                    )}
                    <h3>${_("Number of Unique Visitors")}</h3>
                    <div class="line-chart-wrapper">
                        <div id="lineChart">
                            <svg>
                                <defs>
                                    <linearGradient id="lineChart--gradientBackgroundArea" x1="0" x2="0" y1="0" y2="1">
                                      <stop class="lineChart--gradientBackgroundArea--top" offset="0%" />
                                      <stop class="lineChart--gradientBackgroundArea--bottom" offset="100%" />
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                    </div>
                </div>
              % endif
            % endif
            ## ${HTML(render_bundle('CourseReport'))}
            ## ${HTML(render_bundle('ReactRenderer'))}
            <div id="course-report"></div>
            <script type="text/javascript">
              new ReactRenderer({
                component: CourseReport,
                selector: '#course-report',
                componentName: 'CourseReport',
                props: {
                    last_update:'${context.get("last_update", "")}',
                    defaultLanguage: '${request.LANGUAGE_CODE}',
                    token:'${ csrf_token }',
                  }
              });
            </script>
          </div>
        </section>
    </div>
</main>

##<%static:webpack entry="CourseReport">
##    new CourseReport();
##</%static:webpack>

% if course_report:
    <!-- load the d3.js library -->
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="${static.url('js/triboo_analytics/charts.js')}"></script>

    <!-- the script -->
    <script type="text/javascript">
    var pieChartData = [
      {
        color       : 'green',
        value       : ${course_report.finished},
        percent     : ${course_report.finished} / ${course_report.enrollments}
      },
      {
        color       : 'red',
        value       : ${course_report.failed},
        percent     : ${course_report.failed} / ${course_report.enrollments}
      },
      {
        color       : 'orange',
        value       : ${course_report.in_progress},
        percent     : ${course_report.in_progress} / ${course_report.enrollments}
      },
      {
        color       : 'gray',
        value       : ${course_report.not_started},
        percent     : ${course_report.not_started} / ${course_report.enrollments}
      }
    ];

    drawPieChart('pieChart', pieChartData);
    </script>
% endif
% if unique_visitors_csv_data and len(unique_visitors_csv_data) > 0:
    <script type="text/javascript">
        var lineChartCsvData = "date,value\n" + "${unique_visitors_csv_data['per_day']}";
        drawLineChart('lineChart', lineChartCsvData, false);
    </script>
% endif
<script type="text/javascript">
  $(function() {
    var pull = $('#toggle-user-properties');
    var menu = $('#user-properties-selection');

    $(pull).on('click', function(e) {
      e.preventDefault();
      menu.slideToggle();
    });

    $(window).on("load", function() {
        $(".table-filter-form #id_query_string").val("");
        $(".table-filter-form #id_queried_field").find("option[value='user__profile__name']").attr("selected",true)
    });
  });
</script>

