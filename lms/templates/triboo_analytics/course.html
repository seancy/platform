<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%!
    from urllib import urlencode
    from django.utils.translation import ugettext as _, ungettext, gettext
    from django.core.urlresolvers import reverse
    from django.template import Template, Context
    from triboo_analytics.models import CourseStatus, format_time_spent

    import json
    from openedx.core.djangolib.markup import HTML
    from webpack_loader.templatetags.webpack_loader import render_bundle
%>

<%block name="pagetitle">${_("Analytics - Course Report")}</%block>
<%block name="bodyclass">view-in-analytics</%block>
<main id="main" aria-label="Content" tabindex="-1">
    <div class="main-container">
        <%include file="banner_nav.html" args="active_page='course'" />

        ${HTML(render_bundle('CourseReport'))}
        ${HTML(render_bundle('ReactRenderer'))}

        <section class="analytics-wrapper course">
          <div class="report-wrapper">
              <h3>${_("Course Report")}</h3>
              <div class="analytics-header" id="course-report-dropdown"></div>
            % if courses:
              <script type="text/javascript">
                new ReactRenderer({
                  component: CourseReportDropdown,
                  selector: '#course-report-dropdown',
                  componentName: 'CourseReportDropdown',
                  props: {
                      'token':'${ csrf_token }',
                      'submitText':'${_("Go")}',
                      'labelText':'${_("Please select a course to see your report:")}',

                      'data':${json.dumps([{'value': item[0], 'text':item[1]} for item in courses]) | n},
                      'value':'${course_id}',
                      'url':'${reverse("analytics_course")}'
                    }
                });
              </script>
             % endif

              <div class="analytics-header">
                % if error_message:
                  <p class="error">${error_message}</p>
                % endif
                % if course_name:
                  <a href="${reverse('info', args=[course_id])}"><h2><i class="fal fa-file-alt"></i>${course_name}</h2></a>
                % endif
              </div>
            % if course_report:
              <div class="analytics-widgets">
                % if len(unique_visitors_csv) > 0:
                  <div class="analytics-basic-wrapper analytics-basic-wrapper--grow">
                      <section class="analytics-widget analytics-linechart analytics-widget-enrollmentschart analytics-widget--row2">
                          <div class="analytics-widget__caption">
                              <h3>${_("Number of Unique Visitors")}</h3>
                              ${static.renderReact(
                                component="QuestionMark",
                                id="id-number-of-unique-course-visitors",
                                props={
                                  'class':'question-mark',
                                  'tooltip': gettext('Number of different visitors who opened the course per day'),
                                }
                              )}
                          </div>
                          <main>
                              <div class="analytics-widget__chart" id="lineChart"></div>
                          </main>
                      </section>
                  </div>
                % endif
                  <div class="analytics-basic-wrapper analytics-basic-wrapper--shrink">
                      <section class="analytics-widget analytics-figure analytics-widget-enrollments analytics-widget--col1">
                          <div class="analytics-widget__caption">
                              <h3>${ungettext("Enrollment", "Enrollments", course_report.enrollments)}</h3>
                              ${static.renderReact(
                                component="QuestionMark",
                                id="id-enrollments",
                                props={
                                  'class':'question-mark',
                                  'tooltip': gettext('Number of learners enrolled in the course. The learners have been registered by an Admin or self-registered via the catalog'),
                                }
                              )}
                          </div>
                          <main>
                              <p class="figure">${course_report.enrollments}</p>
                          </main>
                      </section>

                      <section class="analytics-widget analytics-figure analytics-widget-averagescore analytics-widget--col1">
                          <div class="analytics-widget__caption">
                              <h3>${_("Average Final Score")}</h3>
                              ${static.renderReact(
                                component="QuestionMark",
                                id="id-average-final-score",
                                props={
                                  'class':'question-mark',
                                  'tooltip': gettext('Average total score of the learners who completed the course with 100% progress'),
                                }
                              )}
                          </div>
                          <main>
                              <p class="figure">${course_report.average_final_score}&nbsp;%</p>
                          </main>
                      </section>

                      <section class="analytics-widget analytics-piechart analytics-widget-statuschart analytics-widget--col2">
                          <main>
                              <div class="analytics-widget__chart" id="pieChart"></div>
                          </main>
                          <aside>
                              <div class="analytics-widget__caption">
                                  <h3></h3>
                                  ${static.renderReact(
                                    component="QuestionMark",
                                    id="id-donuts-chart",
                                    props={
                                      'class':'question-mark',
                                      'tooltip': gettext('Proportion of learners according to their course status'),
                                    }
                                  )}
                              </div>
                              <div class="legend">
                                  <div class="status-label">
                                      <span class="finished">&#9679;</span>
                                      ${_(CourseStatus.verbose_names[CourseStatus.finished])}
                                      ${static.renderReact(
                                        component="QuestionMark",
                                        id="id-finished-2",
                                        props={
                                          'class':'status-message',
                                          'tooltip': gettext('Leaners who completed the course with 100% progress and a total score passing the minimum required score'),
                                        }
                                      )}
                                  </div>
                                  <div class="status-label">
                                      <span class="failed">&#9679;</span>
                                      ${_(CourseStatus.verbose_names[CourseStatus.failed])}
                                      ${static.renderReact(
                                        component="QuestionMark",
                                        id="id-failed",
                                        props={
                                          'class':'status-message',
                                          'tooltip': gettext('Leaners who completed the course with 100% progress but with a total score below the minimum required score to validate the course'),
                                        }
                                      )}
                                  </div>
                                  <div class="status-label">
                                      <span class="in-progress">&#9679;</span>
                                      ${_(CourseStatus.verbose_names[CourseStatus.in_progress])}
                                      ${static.renderReact(
                                        component="QuestionMark",
                                        id="id-in-progress",
                                        props={
                                          'class':'status-message',
                                          'tooltip': gettext("Learners who started to visit the course but haven't completed it yet"),
                                        }
                                      )}
                                  </div>
                                  <div class="status-label">
                                      <span class="not-started">&#9679;</span>
                                      ${_(CourseStatus.verbose_names[CourseStatus.not_started])}
                                      ${static.renderReact(
                                        component="QuestionMark",
                                        id="id-not-started",
                                        props={
                                          'class':'status-message',
                                          'tooltip': gettext("Learners who are enrolled in the course but haven't visited it yet"),
                                        }
                                      )}
                                  </div>
                              </div>
                          </aside>
                      </section>

                      <section class="analytics-widget analytics-figure analytics-widget-post analytics-widget--col1">
                          <div class="analytics-widget__caption">
                              <h3>${ungettext("Post", "Posts", course_report.posts)}</h3>
                              ${static.renderReact(
                                component="QuestionMark",
                                id="id-posts",
                                props={
                                  'class':'question-mark',
                                  'tooltip': gettext('Number of posts/answers/comments written in the course discussions/forums'),
                                }
                              )}
                          </div>
                          <main>
                              <p class="figure">${course_report.posts}</p>
                          </main>
                      </section>

                      <section class="analytics-widget analytics-figure analytics-widget-completetime analytics-widget--col2">
                          <div class="analytics-widget__caption">
                              <h3>${_("Average time to complete the course")}</h3>
                              ${static.renderReact(
                                component="QuestionMark",
                                id="id-average-time",
                                props={
                                  'class':'question-mark',
                                  'tooltip': gettext('Average time it took to learners to complete the course with 100% progress'),
                                }
                              )}
                          </div>
                          <main>
                              <p class="figure">${format_time_spent(course_report.average_complete_time)}</p>
                              <!-- <div class="analytics-widget__chart" id="completetimeChart"></div> -->
                          </main>
                      </section>
                  </div>

            % endif
            ## ${HTML(render_bundle('CourseReport'))}
            ## ${HTML(render_bundle('ReactRenderer'))}
            <div id="course-report"></div>
            <script type="text/javascript">
              new ReactRenderer({
                component: CourseReport,
                selector: '#course-report',
                componentName: 'CourseReport',
                props: {
                    last_update:'${context.get("last_update", "")}',
                    defaultLanguage: '${request.LANGUAGE_CODE}',
                    token:'${ csrf_token }',
                  }
              });
            </script>
          </div>
        </section>
    </div>
</main>

##<%static:webpack entry="CourseReport">
##    new CourseReport();
##</%static:webpack>

% if course_report:
    <script type="text/javascript" src="${static.url('js/triboo_analytics/echarts.min.js')}"></script>
    <script type="text/javascript" src="${static.url('js/triboo_analytics/charts.js')}"></script>

    <!-- the script -->
    <script type="text/javascript">
      var pieChartData = [
        ['${_("Successful")}', ${course_report.finished}],
        ['${_("Unsuccessful")}', ${course_report.failed}],
        ['${_("In progress")}', ${course_report.in_progress}],
        ['${_("Not started")}', ${course_report.not_started}],
      ];

      drawPieChart('pieChart', pieChartData, ['green', 'red', 'orange', 'gray'])
    </script>
% endif
% if unique_visitors_csv and len(unique_visitors_csv) > 0:
    <script type="text/javascript">
      var lineChartCsvData = "date,value\n" + "${unique_visitors_csv['per_day']}";
      drawLineChart('lineChart', lineChartCsvData);
    </script>
% endif
<script type="text/javascript">
  $(function() {
    var pull = $('#toggle-user-properties');
    var menu = $('#user-properties-selection');

    $(pull).on('click', function(e) {
      e.preventDefault();
      menu.slideToggle();
    });

    $(window).on("load", function() {
        $(".table-filter-form #id_query_string").val("");
        $(".table-filter-form #id_queried_field").find("option[value='user__profile__name']").attr("selected",true)
    });
  });
</script>
