<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%!
  from django.utils.translation import ugettext as _, ungettext, gettext
  from django.core.urlresolvers import reverse
  from django.template import Template, Context
  from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
  from triboo_analytics.models import CourseStatus, format_time_spent
%>

<%block name="js_extra">
    <script>
        $("#waiver-pop-up").iziModal({
            width: 700,
        });
        var contents = ${course_contents};
        $("#pop-up-form").submit(function (e) {
            e.preventDefault();
            $.notify.defaults({ className: "success" });
            var fx = "shake",  //shake shake
                $modal = $(this).closest('.iziModal'),
                $send_button = $(".send-waiver-request"),
                $waiver_section = $("#waiver-section").find("option:selected"),
                waiver_course = $("#waiver-course").val(),
                waiver_description = $("#waiver-description").val().trim();
            if (waiver_course == 'none' || waiver_description.length == 0){
                if (waiver_course == 'none'){
                    $send_button.notify("${_('Please select a course!')}", {position: 'top-center', className: 'error'});
                }
                else {
                    $send_button.notify("${_('Please the provide the reason. It cannot be empty!')}", {position: 'top-center', className: 'error'});
                }
                if(!$modal.hasClass(fx) ){
                    $modal.addClass(fx);
                    setTimeout(function(){
                        $modal.removeClass(fx);
                    }, 1500);
                }
                return false
            }
            else {
                if ($waiver_section.length == 0) {
                    var sections = [];
                    $.each(contents[waiver_course]['chapters'], function (index, value) {
                        if (value['disabled'] == false) {
                            $.each(value['sections'], function (i, v) {
                                if (v['graded'] == true) {
                                    sections.push(v['usage_id'])
                                }
                            })
                        }
                    })
                }
                else {
                    var sections = {};
                    $waiver_section.each(function () {
                        let sec = [],
                            chapter = contents[waiver_course]['chapters'][$(this).data('id')],
                            name = $(this).val();
                        $.each(chapter['sections'], function (i, v) {
                            if (v['graded'] == true) {
                                sec.push(v['usage_id'])
                            }
                        });
                        if (sec.length > 0) {
                            sections[$(this).val()] = sec
                        }
                    })
                }
            }
            $.ajax({
                type: "post",
                url: "${reverse('waiver_request')}",
                data: {
                    "course_id": waiver_course,
                    "sections": JSON.stringify(sections),
                    "description": waiver_description,
                    "csrfmiddlewaretoken": "${csrf_token}"
                },
                dataType: 'json',
                success: function (data) {
                    $send_button.notify(data.message, {position: 'top-center'});
                    setTimeout(function () {
                        window.location.reload()
                    }, 3000)
                },
                error: function (data) {
                    $send_button.notify(data.responseJSON.message, {position: 'top-center', className: 'error'});
                }
            });
        });
        $("#waiver-pop-up").on('change', '#waiver-course', function () {
            var course_id = $(this).val();
            if (course_id != 'none') {
                $("#waiver-section").html('');
                $("#waiver-section").attr('multiple', 'multiple');

                var chapters = contents[course_id]['chapters'];
                for (var i in chapters) {
                    if (chapters[i]['disabled']) {
                        var option_head = '<option disabled data-id=' + i + '>'
                    }
                    else {
                        var option_head = '<option data-id=' + i + '>'
                    }
                    $("#waiver-section").append(option_head + chapters[i]['display_name'] + '</option>')
                }
            }
            else {
                $("#waiver-section").removeAttr('multiple');
                $("#waiver-section").html('<option selected value="whole course">Select a section</option>')
            }
        });
    </script>
</%block>

<%block name="pagetitle">${_("Analytics - Learning Transcript")}</%block>
<%block name="bodyclass">view-in-analytics</%block>

<style type="text/css">
    @-webkit-keyframes shake {
      from {
        -webkit-transform: none;
        transform: none;
      }

      15% {
        -webkit-transform: translate3d(-15%, 0, 0) rotate3d(0, 0, 1, -5deg);
        transform: translate3d(-15%, 0, 0) rotate3d(0, 0, 1, -5deg);
      }

      30% {
        -webkit-transform: translate3d(10%, 0, 0) rotate3d(0, 0, 1, 3deg);
        transform: translate3d(10%, 0, 0) rotate3d(0, 0, 1, 3deg);
      }

      45% {
        -webkit-transform: translate3d(-5%, 0, 0) rotate3d(0, 0, 1, -3deg);
        transform: translate3d(-5%, 0, 0) rotate3d(0, 0, 1, -3deg);
      }

      60% {
        -webkit-transform: translate3d(3%, 0, 0) rotate3d(0, 0, 1, 2deg);
        transform: translate3d(3%, 0, 0) rotate3d(0, 0, 1, 2deg);
      }

      75% {
        -webkit-transform: translate3d(-2%, 0, 0) rotate3d(0, 0, 1, -1deg);
        transform: translate3d(-2%, 0, 0) rotate3d(0, 0, 1, -1deg);
      }

      to {
        -webkit-transform: none;
        transform: none;
      }
    }

    @keyframes shake {
      from {
        -webkit-transform: none;
        transform: none;
      }

      15% {
        -webkit-transform: translate3d(-15%, 0, 0) rotate3d(0, 0, 1, -5deg);
        transform: translate3d(-15%, 0, 0) rotate3d(0, 0, 1, -5deg);
      }

      30% {
        -webkit-transform: translate3d(10%, 0, 0) rotate3d(0, 0, 1, 3deg);
        transform: translate3d(10%, 0, 0) rotate3d(0, 0, 1, 3deg);
      }

      45% {
        -webkit-transform: translate3d(-5%, 0, 0) rotate3d(0, 0, 1, -3deg);
        transform: translate3d(-5%, 0, 0) rotate3d(0, 0, 1, -3deg);
      }

      60% {
        -webkit-transform: translate3d(3%, 0, 0) rotate3d(0, 0, 1, 2deg);
        transform: translate3d(3%, 0, 0) rotate3d(0, 0, 1, 2deg);
      }

      75% {
        -webkit-transform: translate3d(-2%, 0, 0) rotate3d(0, 0, 1, -1deg);
        transform: translate3d(-2%, 0, 0) rotate3d(0, 0, 1, -1deg);
      }

      to {
        -webkit-transform: none;
        transform: none;
      }
    }

    .shake {
      -webkit-animation-name: shake;
      animation-name: shake;
      -webkit-animation-duration: 1s;
      animation-duration: 1s;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
    }
</style>

<main id="main" aria-label="Content" tabindex="-1">
    <div class="main-container">
        <section class="banner">
          <section class="welcome-wrapper">
            <h2>${_("Learning Transcript")}</h2>
            <h3>${_("Let's have a look at your learning experience!")}</h3>
          </section>
        </section>
        <section class="analytics-wrapper transcript">
          <div class="report-wrapper">
              <div class="analytics-header">
                % if configuration_helpers.get_value("ENABLE_WAIVER_REQUEST", False):
                  <button class="request-waiver" data-izimodal-open="#waiver-pop-up">${_("Request a waiver")}</button>
                % endif
              </div>
              <div class="waiver-pop-up" id="waiver-pop-up" data-iziModal-group="group1">
                  <span class="waiver-x" data-iziModal-close>X</span>
                  <header>
                      <h2>${_("Request a waiver for a course or a section")}</h2>
                  </header>
                  <form class="pop-up-form" id="pop-up-form" method="post">
                      <input name="csrfmiddlewaretoken" value="${csrf_token}" type="hidden">
                      <p>${_("Here you can request a waiver for an entire course or a module of a course, "
                             "please select a course and the specific section(s) of the course. If you want to ask a waiver for an entire course, "
                             "just select the course and leave the section blank.")}
                      </p>
                      <select class="waiver-course" id="waiver-course" name="waiver-course">
                          <option selected value="none">${_("Select a course")}</option>
                          % for c in courses:
                              <option value="${c['id']}">${c['display_name']}</option>
                          % endfor
                      </select>
                      <select class="waiver-section" id="waiver-section" name="waiver-section">
                          <option selected value="whole course" disabled>${_("Select the section(s)")}</option>
                      </select>
                      <p class="waiver-justify">${_("Justify the reasons why you are requesting for this waiver")}</p>
                      <textarea id="waiver-description" name="waiver-description"></textarea>
                      <p>${_("After sending your request, the course admin will assess it and you will receive an answer by email.")}</p>
                      <footer>
                          <button class="send-waiver-request" type="submit">${_("Send")}</button>
                      </footer>
                  </form>
              </div>
            % if learner_report_enrollments:
              <div class="analytics-basic-wrapper">
                  <div class="analytics-float-wrapper">
                      <div class="analytics-basic-wrapper">
                          <div class="analytics-widget-24 analytics-figure">
                              ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-enrollment",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Number of courses you are enrolled in'),
                                  }
                                )}
                              <p class="figure">${learner_report_enrollments}</p>
                              <p class="title">${ungettext("Enrollment", "Enrollments", learner_report_enrollments)}</p>
                          </div>
                          <div class="analytics-widget-24 analytics-figure">
                              ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-time-spent",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Total time you have spent on the platform'),
                                  }
                                )}
                              <p class="figure">${format_time_spent(learner_report_total_time_spent)}</p>
                              <p class="title">${_("Time spent on the platform")}</p>
                          </div>
                      </div>
                      <div class="analytics-basic-wrapper">
                          <div class="analytics-widget-24 analytics-figure">
                              ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-average-final-score",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Average final score over all the courses you have completed (status successful or unsuccessful)'),
                                  }
                                )}
                              <p class="figure">${learner_report_average_final_score}&nbsp;%</p>
                              <p class="title">${_("Average Final Score")}</p>
                          </div>
                          <div class="analytics-widget-24 analytics-figure">
                              ${static.renderReact(
                                  component="QuestionMark",
                                  id="id-posts",
                                  props={
                                    'class':'question-mark',
                                    'tooltip': gettext('Number of posts/answers/comments you have written in the discussions/forums'),
                                  }
                                )}
                              <p class="figure">${learner_report_posts}</p>
                              <p class="title">${ungettext("Post", "Posts", learner_report_posts)}</p>
                          </div>
                      </div>
                  </div>
                  <div class="analytics-float-wrapper">
                    <div class="analytics-widget-24 analytics-piechart">
                        ${static.renderReact(
                          component="QuestionMark",
                          id="id-donuts-chart",
                          props={
                            'class':'question-mark',
                            'tooltip': gettext('Proportion of courses according to your progress'),
                          }
                        )}

                      <div id="pieChart">
                          <svg></svg>
                      </div>
                      <div class="legend">
                        <div class="status-label">
                            <span class="finished">&#9679;</span>
                            ${_(CourseStatus.verbose_names[CourseStatus.finished])}
                            ${static.renderReact(
                              component="QuestionMark",
                              id="id-finished-2",
                              props={
                                'class':'status-message',
                                'tooltip': gettext('Number of courses you completed with 100% progress and a total score passing the minimum required score'),
                              }
                            )}
                        </div>
                        <div class="status-label">
                            <span class="failed">&#9679;</span>
                            ${_(CourseStatus.verbose_names[CourseStatus.failed])}
                            ${static.renderReact(
                              component="QuestionMark",
                              id="id-failed",
                              props={
                                'class':'status-message',
                                'tooltip': gettext('Number of courses you completed with 100% progress but with a total score below the minimum required score'),
                              }
                            )}
                        </div>
                        <div class="status-label">
                            <span class="in-progress">&#9679;</span>
                            ${_(CourseStatus.verbose_names[CourseStatus.in_progress])}
                            ${static.renderReact(
                              component="QuestionMark",
                              id="id-in-progress",
                              props={
                                'class':'status-message',
                                'tooltip': gettext("Number of courses you started to visit but you haven't completed yet"),
                              }
                            )}
                        </div>
                        <div class="status-label">
                            <span class="not-started">&#9679;</span>
                            ${_(CourseStatus.verbose_names[CourseStatus.not_started])}
                            ${static.renderReact(
                              component="QuestionMark",
                              id="id-not-started",
                              props={
                                'class':'status-message',
                                'tooltip': gettext("Number of courses you are enrolled in but you haven't visited yet"),
                              }
                            )}
                        </div>
                      </div>

                    </div>
                  </div>
                  <div class="table-pdf-view">
                      <button id="table-pdf-button">
                          <i class="far fa-print"></i>
                            ${_("Print")}
                      </button>
                  </div>
              </div>

              <div class="last-update">
                <i class="fa fa-history"></i>${_("Please, note that these reports are not live. Last update:")} ${last_update}
              </div>

              <% tpl = "{% load render_table from django_tables2 %}{% render_table learner_course_table 'triboo_analytics/table.html' %}" %>
              ${Template(tpl).render(Context({'learner_course_table': learner_course_table, 'request': request}))}

              <%include file="download.html" args="list_table_downloads_url=list_table_downloads_url" />
            % endif
          </div>
        </section>
    </div>
</main>

% if learner_report_enrollments:
  <!-- load the d3.js library -->
  <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
  <script type="text/javascript" src="${static.url('js/triboo_analytics/charts.js')}"></script>


  <!-- the script -->
  <script type="text/javascript">
  var pieChartData = [
    {
      color       : 'green',
      value       : ${learner_report_finished},
      percent     : ${learner_report_finished} / ${learner_report_enrollments}
    },
    {
      color       : 'red',
      value       : ${learner_report_failed},
      percent     : ${learner_report_failed} / ${learner_report_enrollments}
    },
    {
      color       : 'orange',
      value       : ${learner_report_in_progress},
      percent     : ${learner_report_in_progress} / ${learner_report_enrollments}
    },
    {
      color       : 'gray',
      value       : ${learner_report_not_started},
      percent     : ${learner_report_not_started} / ${learner_report_enrollments}
    }
  ];

  drawPieChart('pieChart', pieChartData);

    $('#table-pdf-button').click(function(e){
        e.preventDefault();
        window.open("${reverse('analytics_my_transcript_pdf')}");
    });
  </script>
% endif
