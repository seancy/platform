<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%!
  from django.utils.translation import ugettext as _
  from django.utils.translation import ungettext
  from django.core.urlresolvers import reverse
  from django.template import Template, Context
  from triboo_analytics.models import CourseStatus, format_time_spent, ANALYTICS_LIMITED_ACCESS_GROUP
%>

<%block name="pagetitle">${_("Analytics - Learner Transcript")}</%block>
<%block name="bodyclass">view-in-analytics</%block>

<main id="main" aria-label="Content" tabindex="-1">
    <div class="main-container">
        <section class="banner">
          <section class="welcome-wrapper">
            <h2>${_("Analytics")}</h2>
          </section>
        </section>
        <nav>
            <ol class="tabs analytics-tabs">
                <li class="tab"><a href="${reverse('analytics_microsite')}">${_("Global Report")}</a></li>
                <li class="tab"><a href="${reverse('analytics_course')}">${_("Course Report")}</a></li>
              % if ANALYTICS_LIMITED_ACCESS_GROUP not in [group.name for group in user.groups.all()]:
                <li class="tab"><a href="${reverse('analytics_learner')}" class="active">${_("Learner Report")}</a></li>
              % endif
                <li class="tab"><a href="${reverse('analytics_ilt')}">${_("ILT Report")}</a></li>
            </ol>
        </nav>
        <section class="analytics-wrapper transcript">
          <div class="report-wrapper">
            <div class="analytics-header">
              % if error_message:
                <h2>${_("Learning Transcript")}</h2>
                <div class="analytics-summary">
                    <p class="error">${error_message}</p>
                </div>
              % else:
                <h2>${_("Learning Transcript of")} ${user_profile_name}</h2>
              % endif
            </div>

            % if learner_report_enrollments:
              <div class="analytics-basic-wrapper">
                  <div class="analytics-float-wrapper">
                      <div class="analytics-basic-wrapper">
                          <div class="analytics-widget-24 analytics-figure">
                              <p class="figure">${learner_report_enrollments}</p>
                              <p class="title">${ungettext("Enrollment", "Enrollments", learner_report_enrollments)}</p>
                          </div>
                          <div class="analytics-widget-24 analytics-figure">
                              <p class="figure">${format_time_spent(learner_report_total_time_spent)}</p>
                              <p class="title">${_("Time spent on the platform")}</p>
                          </div>
                      </div>
                      <div class="analytics-basic-wrapper">
                          <div class="analytics-widget-24 analytics-figure">
                              <p class="figure">${learner_report_average_final_score}&nbsp;%</p>
                              <p class="title">${_("Average Final Score")}</p>
                          </div>
                          <div class="analytics-widget-24 analytics-figure">
                              <p class="figure">${learner_report_posts}</p>
                              <p class="title">${ungettext("Post", "Posts", learner_report_posts)}</p>
                          </div>
                      </div>
                  </div>
                  <div class="analytics-float-wrapper">
                    <div class="analytics-widget-24 analytics-piechart">
                        <div id="pieChart">
                            <svg></svg>
                        </div>
                        <div class="legend">
                          <p><span class="finished">&#9679;</span> ${_(CourseStatus.verbose_names[CourseStatus.finished])}</p>
                          <p><span class="failed">&#9679;</span> ${_(CourseStatus.verbose_names[CourseStatus.failed])}</p>
                          <p><span class="in-progress">&#9679;</span> ${_(CourseStatus.verbose_names[CourseStatus.in_progress])}</p>
                          <p><span class="not-started">&#9679;</span> ${_(CourseStatus.verbose_names[CourseStatus.not_started])}</p>
                        </div>
                    </div>
                  </div>
              </div>

              <div class="last-update">
                <i class="fa fa-history"></i>${_("Please, note that these reports are not live. Last update:")} ${last_update}
              </div>

              <% tpl = "{% load render_table from django_tables2 %}{% render_table learner_course_table 'triboo_analytics/table.html' %}" %>
              ${Template(tpl).render(Context({'learner_course_table': learner_course_table, 'request': request}))}
            % endif
          </div>
        </section>
    </div>
</main>

% if learner_report_enrollments:
  <!-- load the d3.js library -->
  <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
  <script type="text/javascript" src="${static.url('js/triboo_analytics/charts.js')}"></script>


  <!-- the script -->
  <script type="text/javascript">
  var pieChartData = [
    {
      color       : 'green',
      value       : ${learner_report_finished},
      percent     : ${learner_report_finished} / ${learner_report_enrollments}
    },
    {
      color       : 'red',
      value       : ${learner_report_failed},
      percent     : ${learner_report_failed} / ${learner_report_enrollments}
    },
    {
      color       : 'orange',
      value       : ${learner_report_in_progress},
      percent     : ${learner_report_in_progress} / ${learner_report_enrollments}
    },
    {
      color       : 'gray',
      value       : ${learner_report_not_started},
      percent     : ${learner_report_not_started} / ${learner_report_enrollments}
    }
  ];

  drawPieChart('pieChart', pieChartData);
  </script>
% endif
